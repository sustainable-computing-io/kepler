name: mock-acpi
include:
  - path:
    - ../compose.yaml
    - ./override.yaml

services:
  ### ðŸ“¦ kepler created from the current repo (local development)
  kepler-dev:
    build:
      context: ../../../
      dockerfile: build/Dockerfile
    ports:
      # NOTE: use 9188 to keep the host 8888 port free for any local testing
      # e.g. sudo ./bin/kepler 
      - "9188:8888"
    privileged: true
    pid: host

    volumes:
      - type: bind
        source: /proc
        target: /proc
      - type: bind
        source: /sys
        target: /sys
      - type: bind
        source: ./kepler/etc/kepler
        target: /etc/kepler

      # NOTE: use the weights from the local repo
      - type: bind
        source: ../../../data/model_weight/
        target: /var/lib/kepler/data
      - type: bind
        source: ../../../data/cpus.yaml
        target: /var/lib/kepler/data/cpus.yaml
      - "mock-acpi:/var/mock-acpi:z"

    entrypoint: [/usr/bin/bash, -c]

    command:
      - |
        echo Starting kepler;
        # NOTE: uncomment to wait for estimator container
        # echo waiting for estimator socket to be ready;
        # until [[ -e /tmp/estimator.sock ]]; do
        #   echo " ... waiting for socket";
        #   sleep 1;
        # done;
        set -x;
        /usr/bin/kepler \
          -address "0.0.0.0:8888" \
          -v "5" \
          -enable-cgroup-id=true \
          -enable-gpu=false
    networks:
      - kepler-network
    cap_add:
      - ALL

  mock-acpi:
    build:
      context: ./mock-acpi
      dockerfile: Dockerfile
    depends_on:
      - prometheus
    volumes:
      - type: bind
        source: ./mock-acpi-config/
        target: /var/mock-acpi-config/
      - mock-acpi:/var/mock-acpi
    networks:
      - kepler-network

  intel-pcm:
    image: ghcr.io/intel/pcm:latest
    privileged: true
    cap_add:
      - ALL
    ports:
      - "9738:9738"
    depends_on:
      - prometheus
    volumes:
      - type: bind
        source: /proc
        target: /proc
      - type: bind
        source: /sys
        target: /sys
      - type: bind
        source: ./pcm-grafana
        target: /work
    environment:
      PCM_NO_PERF: "0"
    entrypoint: [/usr/bin/bash, -c]
    command:
      - |
        echo Starting intel-pcm;
        set -x;
        pcm-sensor-server
    networks:
      - kepler-network

  intel-pcm-dashboard-getter:
    image: ghcr.io/opcm/pcm:latest
    depends_on:
      - intel-pcm
    volumes:
      - type: bind
        source: ./grafana/dashboards/intel-pcm
        target: /intel-pcm-dashboard
    entrypoint: [/usr/bin/bash, -c]
    command:
      - |
        echo Starting intel-pcm-dashboard-getter;
        set +x
        repeat() {
          while true; do
            "$@"  && return
            sleep 1
            echo "trying again..."
          done
        }
        repeat curl -s -o /intel-pcm-dashboard/pcm-dashboard.json intel-pcm:9738/dashboard/prometheus
    networks:
      - kepler-network

volumes:
  # volume for overriding acpi path
  mock-acpi:
